<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filter Leads</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Filter Leads by Roles</h2>
            <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Dashboard
            </a>
        </div>

        {% if not file_uploaded %}
        <div class="form-container">
            <form method="POST" enctype="multipart/form-data" id="upload-form">
                <div class="mb-4">
                    <label class="form-label">Upload File</label>
                    <div class="drop-zone">
                        <input type="file" name="file" class="file-input" accept=".csv,.xlsx,.xls" required>
                        <div class="drop-zone-icon">
                            <i class="bi bi-cloud-arrow-up"></i>
                        </div>
                        <p class="drop-zone-text">Drag & drop your file here or Click to browse...</p>
                        <p class="drop-zone-hint">Supports: CSV, XLSX, XLS (Max: 2GB)</p>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="form-label">Enter Roles to Filter (One per line)</label>
                    <textarea class="form-control" id="roles-textarea" name="roles_text" rows="4" placeholder="Enter Job Roles For example: CEO, Software Engineer etc..."></textarea>
                   
                </div>

                <div class="mb-3">
                    <label class="form-label">Selected Roles:</label>
                    <div id="selected-roles-container" class="d-flex flex-wrap gap-2 mb-2">
                        {% if selected %}
                            {% for role in selected %}
                            <span class="badge bg-primary d-flex align-items-center">
                                {{ role }}
                                <input type="hidden" name="roles" value="{{ role }}">
                            </span>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <div id="no-roles-message" class="text-muted" {% if selected %}style="display: none;"{% endif %}>
                        No roles selected yet. Enter roles above and they will appear here.
                    </div>
                </div>
                
                <div class="d-flex justify-content-center">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-funnel"></i> Filter Leads
                    </button>
                </div>
            </form>
        </div>
        {% endif %}

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div class="mt-3">
              {% for category, msg in messages %}
                <div class="alert alert-{{ category }}">{{ msg }}</div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}

        {% if preview %}
        <div class="table-container">
            <div class="preview-controls">
                <h4 class="preview-title">Preview</h4>
                <div>
                    <label for="preview-select" class="me-2">Show:</label>
                    <select id="preview-select" class="preview-select">
                        <option value="10" {% if preview_count == 10 %}selected{% endif %}>10 rows</option>
                        <option value="25" {% if preview_count == 25 %}selected{% endif %}>25 rows</option>
                        <option value="50" {% if preview_count == 50 %}selected{% endif %}>50 rows</option>
                        <option value="100" {% if preview_count == 100 %}selected{% endif %}>100 rows</option>
                        <option value="250">250 rows</option>
                        <option value="500">500 rows</option>
                        <option value="1000">1000 rows</option>
                    </select>
                    <small class="text-muted ms-2">Total: {{ total_rows }} rows</small>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                    <tr>
                        <th>Name</th><th>Email</th><th>Phone</th><th>Company</th><th>Title</th>
                    </tr>
                    </thead>
                    <tbody id="preview-table">
                    {% for row in preview %}
                    <tr>
                        <td>{{ row.Name }}</td>
                        <td>{{ row.Email }}</td>
                        <td>{{ row.Phone }}</td>
                        <td>{{ row.Company }}</td>
                        <td>{{ row.Title }}</td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="d-flex justify-content-center gap-3 mt-4">
            {% if file_path %}
            <a href="{{ url_for('download_file', filename=file_path) }}" class="btn btn-success btn-lg">
                <i class="bi bi-download"></i> Download CSV
            </a>
            {% endif %}
            <a href="{{ url_for('filter_leads') }}" class="btn btn-outline-primary btn-lg">
                <i class="bi bi-arrow-repeat"></i> Process Another File
            </a>
        </div>
        {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script>
        window.previewData = {{ preview|tojson | default('[]') }};
        window.filePath = {{ file_path|tojson | default('') }};
        window.totalRows = {{ total_rows | default(0) }};
        window.fileUploaded = {{ file_uploaded | tojson | default('false') }};
        
        // Initialize preview with current selection
        document.addEventListener('DOMContentLoaded', function() {
            const previewSelect = document.getElementById('preview-select');
            if (previewSelect) {
                updatePreview(previewSelect.value);
            }
            
            // Initialize role textarea functionality
            initializeRoleTextarea();
        });

        function initializeRoleTextarea() {
            const textarea = document.getElementById('roles-textarea');
            const container = document.getElementById('selected-roles-container');
            const noRolesMessage = document.getElementById('no-roles-message');
            const form = document.getElementById('upload-form');

            if (!textarea) return;

            // Process roles from textarea on form submission
            form.addEventListener('submit', function(e) {
                const rolesText = textarea.value.trim();
                if (rolesText) {
                    const roles = rolesText.split('\n')
                        .map(role => role.trim())
                        .filter(role => role.length > 0);
                    
                    // Clear existing hidden inputs
                    const existingInputs = container.querySelectorAll('input[type="hidden"]');
                    existingInputs.forEach(input => input.remove());
                    
                    // Add new hidden inputs for each role
                    roles.forEach(role => {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'roles';
                        input.value = role;
                        container.appendChild(input);
                    });
                }
            });

            // Update visual display as user types
            textarea.addEventListener('input', function() {
                const rolesText = textarea.value.trim();
                const roles = rolesText.split('\n')
                    .map(role => role.trim())
                    .filter(role => role.length > 0);
                
                // Update visual badges
                container.innerHTML = '';
                if (roles.length > 0) {
                    noRolesMessage.style.display = 'none';
                    roles.forEach(role => {
                        const badge = document.createElement('span');
                        badge.className = 'badge bg-primary d-flex align-items-center';
                        badge.textContent = role;
                        container.appendChild(badge);
                    });
                } else {
                    noRolesMessage.style.display = 'block';
                }
            });

            // Initialize with any existing selected roles
            if (container.querySelectorAll('input[type="hidden"]').length > 0) {
                noRolesMessage.style.display = 'none';
            }
        }
    </script>
</body>
</html>